##########################################################################
# This file is centrally managed, any manual changes will be OVERWRITTEN #
##########################################################################

[main]
  vardir = /var/lib/puppet
  ssldir = $vardir/ssl
  libdir = $vardir/lib
  logdir = /var/log/puppet
  rundir = /var/run/puppet
  pluginsync = true
  plugindest = $vardir/lib
  report = true
<%# Master-Agent setup -%>
<% if @puppet_server != "false" %>
  server = <%= @puppet_server %>
  # Whether to allow a new certificate request to overwrite an existing certificate.
  allow_duplicate_certs = true
  # How often puppet agent applies the client configuration; in seconds. Now: 30m (the default)
  runinterval = <%= @puppet_agent_runinterval %>
  # Whether to sleep for a pseudo-random (but consistent) amount of time before a run.
  splay = true
  # The maximum time to delay before runs. Defaults to being the same as the run interval. Can be specified as a duration.
  splaylimit = 600
<% if @puppet_environment %>
<%# We can define the environment on the node definition -%>
  environment = <%= @puppet_environment -%> 
<% elsif @environment == 'production' -%>
<%# Make the default environment to be 'default' -%>
  environment = production
<% else -%>
<%# If the agent sends the environment variable (--environment) it is set here as well -%>
  environment = <%= @environment -%> 
<% end -%>
<%# Master-less setup -%>
<% else -%>
  modulepath = /opt/tid/puppet/$environment/modules:/opt/tid/puppet/core/modules
<% end -%>

<% if @master -%>
[master]
<% if @puppet_server %>
  # It hardcodes the hostname on the SSL handkshake
  certname = <%= @puppet_server %>
<% end -%>
  storeconfigs = true
  storeconfigs_backend = puppetdb
  autosign = true
<% if @foreman -%>
  reports = log, foreman
  external_nodes = /etc/puppet/node.rb
  node_terminus = exec
<% else -%>
  reports = log
<% end -%>
  # Set environment path to complain with puppet 4 directory configurations
  environmentpath = $vardir/initiatives
  basemodulepath = $vardir/initiatives/shared/modules:/etc/puppet/modules
  
<% end %>

[agent]
  # The file in which puppetd stores a list of the classes
  # associated with the retrieved configuratiion.  Can be loaded in
  # the separate ``puppet`` executable using the ``--loadclasses``
  # option.
  # The default value is '$confdir/classes.txt'.
  classfile = $vardir/classes.txt

  # Where puppetd caches the local configuration.  An
  # extension indicating the cache format is added automatically.
  # The default value is '$confdir/localconfig'.
  localconfig = $vardir/localconfig

