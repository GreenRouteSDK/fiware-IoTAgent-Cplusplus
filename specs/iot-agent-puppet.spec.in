%define debug_package %{nil}
%define __os_install_post %{nil}
%define __prelink_undo_cmd %{nil}
%define name @CPACK_PACKAGE_NAME@-puppet
Name:          @CPACK_PACKAGE_NAME@-puppet
Version:       @CPACK_PACKAGE_VERSION@
Release:       @CPACK_PACKAGE_RELEASE@
Summary:       IoT - IoTAgent
Group:         PDI-IoT
License:       PDI
BuildArch:     x86_64
BuildRoot:     @CMAKE_CURRENT_BINARY_DIR@/pack/Linux/RPM/%{name}
AutoReqProv:   no
Prefix: /usr/local/iot
#requires:
%define _rpmdir @CMAKE_CURRENT_BINARY_DIR@/pack/Linux/RPM
%define _rpmfilename %{name}-@CPACK_PACKAGE_FILE_NAME@.rpm
%define _unpackaged_files_terminate_build 0
%define _topdir @CMAKE_CURRENT_BINARY_DIR@/pack/Linux/RPM

%description
IoT - IoTAgent Puppet Recipes
%install
pwd
mkdir -p %{buildroot}/usr/local/iot/puppet/modules
mkdir -p %{buildroot}/usr/local/iot/puppet/manifests
mkdir -p %{buildroot}/usr/local/iot/puppet/hieradata
mkdir -p %{buildroot}/etc/puppet
mkdir -p %{buildroot}/var/lib/puppet/state/
cp -r @CMAKE_CURRENT_SOURCE_DIR@/puppet/puppet-core/modules/*  %{buildroot}/usr/local/iot/puppet/modules/
cp -r @CMAKE_CURRENT_SOURCE_DIR@/puppet/shared_puppet/modules/*  %{buildroot}/usr/local/iot/puppet/modules/

cp -ax @CMAKE_CURRENT_SOURCE_DIR@/puppet/pack/hiera.yaml  %{buildroot}/etc/puppet/
cp -r @CMAKE_CURRENT_SOURCE_DIR@/puppet/modules/*  %{buildroot}/usr/local/iot/puppet/modules/
cp -r @CMAKE_CURRENT_SOURCE_DIR@/puppet/manifests/*  %{buildroot}/usr/local/iot/puppet/manifests/
cp -r @CMAKE_CURRENT_SOURCE_DIR@/puppet/hieradata/*  %{buildroot}/usr/local/iot/puppet/hieradata/

%clean
rm -rf %{buildroot}
%pre
%post
ln -sf /usr/local/iot/puppet/hieradata /var/lib/hiera
ln -sf /etc/puppet/hiera.yaml /etc/hiera.yaml
mkdir -p /var/lib/puppet/state
touch /var/lib/puppet/state/last_run_report.yaml
%preun
%files
/usr/local/iot/puppet/*
/etc/puppet/hiera.yaml
